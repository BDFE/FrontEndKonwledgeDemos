<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>poi搜索</title>
    <!--<link rel="stylesheet" href="http://minedata.cn/minemapapi/v1.1/minemap.css">-->
    <!--<script src="http://minedata.cn/minemapapi/v1.1/minemap.js"></script>-->
    <link rel="stylesheet" href="../../dist/minemap.css">
    <script src="../../dist/minemap-dev.js"></script>


    <link rel="stylesheet" href="http://minedata.cn/minemapapi/demo/css/bootstrap.min.css">
    <script src="http://minedata.cn/minemapapi/demo/js/jquery.min.js"></script>
    <script src="http://minedata.cn/minemapapi/demo/js/bootstrap.min.js"></script>
    <script src="http://minedata.cn/minemapapi/demo/js/MapXMLHttpRequest.js"></script>
</head>
<body>
<style>
    html, body, #map {
        width: 100%;
        height: 100%;
    }

    .search {
        position: absolute;
        float: right;
        top: 5%;
        letf: 10%;
    }
</style>

<div id="map"></div>

<div class="dropdown search" id="searchBox">
    <input type=“text”  id="inputInfo" onkeyup="searchTrigerByPress(event)"
           data-toggle="dropdown" placeholder=“输入查找关键词”  autocomplete="off" required>
    <button onclick="searchByBtnClick()">Search</button>

    <ul id="promptList" class="dropdown-menu" role="menu" aria-labelledby="dropdownMenu1">
    </ul>

</div>

<script>
    minemap.accessToken = '5fa8b08a69b347b99bf0e2722582c5e8';
    minemap.solution = 319;
    var map = new minemap.Map({
        container: 'map',
        style: "http://minedata.cn/minemapapi/baotou/poidisplay.json",
        center: [109.846755, 40.673924],
        zoom: 11,
        pitch: 0
    });
    var serviceAdd = "http://123.207.124.207:8084/minemap-server/service/search/keyword?token=2werewrewrrwerwerertrtr&"
    var geojson = {}
    var promptEnable = false

    var myHttp = new MapXMLHttpRequest()
    //公园，小区，商店，餐馆，购物中心，酒店，火车站，飞机场，医院,汽车站，公交站，学校，政府机构，大学，学校（中小学），公安局，交通局，
    var poiLayers=[
        {id:'park',minzoom:14,iconImage:'park',color:"#00DE67",filter: ["all", ["in", "kindcode", '180304']]},
        {id:'community',minzoom:16,iconImage:'community',color:"#CEDE42",filter: ["all", ["in", "subclass", 1202]]},
        {id:'store',minzoom:16,iconImage:'icon-69',color:"#FFDD50",filter: ["all",["in", "class",13 ], ["!in","kindcode", '130101','130102']]},
        {id:'restaurant',minzoom:15,iconImage:'restaurant',color:"#FFDD50",filter: ["all", ["in", "subclass", 1101]]},
        {id:'shoppingCenter',minzoom:15,iconImage:'shoppingCenter',color:"#FF8C00",filter: ["all",["in", "subclass",1301 ],["in", "kindcode", '130101','130102']]},
        {id:'hotel',minzoom:15,iconImage:'icon-68',color:"#B48EE9",filter: ["all", ["in", "subclass", 1201]]},
        {id:'railwayStation',minzoom:11,iconImage:'icon-65',color:"#0096F2",filter: ["all", ["in", "kindcode", '230103', '230105', '230107']]},
        {id:'airport',minzoom:10,iconImage:'airport-11',color:"#00CBFB",filter: ["all", ["in", "kindcode", '230126']]},
        {id:'hospital',minzoom:16,iconImage:'hospital-11',color:"#FD5400",filter: ["all", ["in", "subclass", 1701]]},
        {id:'busStation',minzoom:16,iconImage:'music-11',color:"#00DE67",filter:["all", ["in", "kindcode", '230100','230108']]},
        {id:'middleSchool',minzoom:13,iconImage:'school-11',color:"#00ABDA",filter: ["all", ["in", "kindcode", '160100','160101','160102','160103','160109']]},
        {id:'government',minzoom:14,iconImage:'town-hall-11',color:"#00A0E9",filter:["all", ["in", "kindcode", '190100','190101','190102','190103']]},
        {id:'college',minzoom:12,iconImage:'icon-64',color:"#FF8C00",filter: ["all", ["in", "kindcode", '160104','160105','160106','160107']]},
        {id:'policeBureau',minzoom:12,iconImage:'icon-65',color:"#0096F2",filter:["all", ["in", "subclass", 1902],["!in", "kindcode", '190203']]},
        {id:'trafficPoliceBureau',minzoom:10,iconImage:'icon-66',color:"#0096F2",filter:["all", ["in", "kindcode", '190203']]},

    ]



    map.on("load", function () {
        map.addSource(
            "Poi_Source", {
                "type": "vector",
                "tiles": ["minemapdata://Poi/{z}/{x}/{y}"]
            }
        )
        poiLayers.forEach(function (layer) {
            map.addLayer({
                "id": layer.id,
                "type": "symbol",
                "source": "Poi_Source",
                "source-layer": "Poi",
                "maxzoom": 18,
                "minzoom": layer.minzoom,
                "layout": {
                    "icon-image": layer.id,
                    "text-field": "{name_zh}",
                    "text-size": 8,
                    "text-offset": [1, 0],
                    "text-anchor": "left",
                    "text-max-width":2,
                },
                "paint": {
                    "text-color": "#000000",
                },
                "filter": layer.filter
            })
        })
    })
    function search() {
        var inputValue = document.getElementById("inputInfo").value
        promptEnable = inputValue ? false : true

        var key = inputValue ? inputValue : "包头交警"
        var adCode = 150200  //包头地理编号150200
        var url = serviceAdd + "adCode=" + adCode + "&key=" + key
        myHttp.send("GET", url, '', callback, null)
    }

    function searchByBtnClick() {
        promptEnable = false
        this.search()
    }
    function searchTrigerByPress(event) {
        if (event.keyCode == 13) {
            this.searchByBtnClick()
        } else {
            this.search()
            promptEnable = true
        }
    }

    function callback(responseText, responseXML) {
        //{"errcode":0,"errmsg":null,"data":{"pageCount":0,"totalCount":0,"pageNumber":0,"rows":[]}}
        var searchResult = {}
        if (responseText.length > 1) {
            searchResult = JSON.parse(responseText)
            if (searchResult.errcode == 0 && searchResult.data.totalCount > 0) {
                translateRes2Geojson(searchResult)
            }
        }
    }


    function init_map(map) {
        geojson = {
            "type": "geojson",
            "data": {
                "type": "FeatureCollection",
                "features": []
            }
        };
        if (!map.getSource("poiSource")) {
            map.addSource("poiSource", geojson)
        }
        if (!map.getLayer("searchResult")) {
            map.addLayer({
                "id": "searchResult",
                "type": "symbol",
                "source": "poiSource",
                "maxzoom": 18,
                "minzoom": 5,
                "layout": {
                    "icon-image": "marker-15",
                    "text-field": "{name}",
                    "text-size": 10,
                    "text-offset": [1, 0],
                    "text-anchor": "left",
                },
                "paint": {
                    "icon-color": "#ff0000",
                    "text-color": "#ff0000",
                },
                filter: ['in', '$type', 'Point']
            })
        }
    }

    function deepCopy(obj) {
        var result = {};
        for (key in obj) {
            var copy = obj[key];
            if (isClass(copy) == "Object") {
                result[key] = arguments.callee(copy);
            } else if (isClass(copy) == "Array") {
                result[key] = arguments.callee(copy);
            } else {
                result[key] = obj[key];
            }
        }
        return result;
    }

    function isClass(o) {
        if (o === null) return "Null";
        if (o === undefined) return "Undefined";
        return Object.prototype.toString.call(o).slice(8, -1);
    }


    function translateRes2Geojson(response) {
        init_map(map)
        response.data.rows.forEach(function (point) {
            var poi = {
                "type": "Feature",
                "geometry": {
                    "type": "Point",
                    "coordinates": []
                },
                "properties": ""
            }
            poi.geometry = deepCopy(point.geom) //geom_display
            poi.properties = deepCopy(point)
            geojson.data.features.push(poi)
        });
        this.displayPoi(map)
    }

    function displayPoi(map) {
        var suggestWrap = document.getElementById("promptList")
        suggestWrap.innerHTML = "";
        if (promptEnable == true) {
            var tmpFrag = document.createDocumentFragment();
            var li;
            var points = this.geojson.data.features
            points.map(function (point) {
                li = document.createElement('LI')
                var alink = document.createElement("a");
                li.setAttribute("style", "role:'presentation';");
                alink.setAttribute("style", "role:'menuitem';", "tabindex:'-1';");
                alink.innerHTML = point.properties.name;
                li.appendChild(alink)
                tmpFrag.appendChild(li)
                suggestWrap.appendChild(tmpFrag);
            })

            var liTags = document.getElementsByTagName("li");
            for (var i = 0; i < liTags.length; i++) {
                cellOnclick(liTags[i], i)

            }

            function cellOnclick(el, i) {
                el.onclick = function () {
                    promptEnable = false
                    var temp = deepCopy(geojson.data.features[i])
                    geojson.data.features.length = 0
                    geojson.data.features.push(temp)
                    displayPoi(map)
                }
            }

        }
        if (promptEnable == false) {
            if (!map.getSource("poiSource")) {
                map.addSource('poiSource', {
                    "type": "geojson",
                    "data": geojson
                });
            } else {
                map.getSource('poiSource').setData(geojson.data);

                if (geojson.data.features.length = 1) {
                    $("#inputInfo").val(geojson.data.features[0].properties.name)
                    var loc = geojson.data.features[0].geometry.coordinates
                    map.flyTo({center: [loc[0],loc[1] ] , zoom: 14})
                }
            }
        }
    }
    var popup = new minemap.Popup({
        closeButton: false,
        closeOnClick: false
    })

    map.on('click', function (e) {
        var features = map.queryRenderedFeatures(e.point, {layers: ["searchResult"]});
        map.getCanvas().style.cursor = (features.length) ? 'pointer' : '';

        if (!features.length) {
            popup.remove();
            return;
        }

        var feature = features[0];
        popup.setLngLat(feature.geometry.coordinates)
            .setHTML("图层：" + feature.layer.id
                + "<br>单位：" + feature.properties.name
                + "<br>经纬度：" + feature.geometry.coordinates)
            .addTo(map);
    });


</script>
</body>
</html>
